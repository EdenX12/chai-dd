<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cc.mrbird.febs.api.mapper.SUserFollowMapper">

        <!-- 通用查询映射结果 -->
        <resultMap id="BaseResultMap" type="cc.mrbird.febs.api.entity.SUserFollow">
                <result column="id" property="id" />
                    <result column="user_id" property="userId" />
                    <result column="product_id" property="productId" />
                    <result column="task_order_id" property="taskOrderId" />
                    <result column="follow_type" property="followType" />
                    <result column="status" property="status" />
                    <result column="create_time" property="createTime" />
                    <result column="update_time" property="updateTime" />
        </resultMap>

        <!-- 通用查询结果列 -->
        <sql id="Base_Column_List">
                id,
            user_id, product_id, task_id, follow_type, status, create_time, update_time
        </sql>

    <select id="findUserFollowDetail" resultType="java.util.Map" parameterType="sUserFollow">

         SELECT
            p.id,
            p.product_name productName,
            p.product_img productImg,
            p.product_des productDes,
            p.product_detail productDetail,
            p.create_time createTime,
            p.create_user createUser,
            p.update_time updateTime,
            p.update_user updateUser,
            p.product_status productStatus,
            p.task_number totalTaskNumber,
            p.product_price productPrice,
            p.total_reward totalReward,
            p.task_price taskPrice,
            p.price_unit priceUnit,
            p.success_reward successReward,
            p.every_reward everyReward,
            p.product_type productType,

            task1.taskNumber taskPayCount,
            ifnull(follow1.followCnt, 0) followCount

            t.id taskId,
            t.task_number taskNumber,

            o.price_type priceType,
            o.order_price orderPrice,
            o.create_time createTime,
            o.end_time endTime,

            ifnull(oc.offerCount, 0) offerCount,

            op.amount amount,
            opu.user_name userName,
            opu.user_phone userPhone

          FROM s_user_follow follow
        LEFT JOIN s_product p ON p.id = follow.product_id
        LEFT JOIN s_task_order o ON o.id = follow.task_order_id
        LEFT JOIN s_user_task t ON t.id = o.task_id

        LEFT JOIN (select product_id, sum(task_number) taskNumber from s_user_task where pay_status = 1 and status != 2 group by product_id) task1
        ON task1.product_id = p.id
        LEFT JOIN (select product_id, count(*) followCnt from s_user_follow where follow_type = 0 and status = 1 group by product_id) follow1
        ON follow1.product_id = p.id

        LEFT JOIN s_product p2 ON p2.id = t.product_id
        LEFT JOIN (SELECT task_order_id, count(*) offerCount FROM s_offer_price WHERE pay_status = 1 GROUP BY task_order_id) oc
        ON oc.task_order_id = o.id

        LEFT JOIN s_offer_price op ON op.task_order_id = o.id AND op.status IN (1, 3)
        LEFT JOIN s_user opu ON opu.id = op.user_id

        WHERE follow.status = 1

        <if test="sUserFollow.userId != null and sUserFollow.userId != ''">
            AND follow.user_id = #{sUserFollow.userId}
        </if>

        </select>
</mapper>
