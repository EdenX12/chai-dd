<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cc.mrbird.febs.api.mapper.SProductMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="cc.mrbird.febs.api.entity.SProduct">
        <result column="id" property="id" />
        <result column="type_id" property="typeId" />
        <result column="product_name" property="productName" />
        <result column="product_img" property="productImg" />
        <result column="product_des" property="productDes" />
        <result column="product_detail" property="productDetail" />
        <result column="create_time" property="createTime" />
        <result column="create_user" property="createUser" />
        <result column="update_time" property="updateTime" />
        <result column="update_user" property="updateUser" />
        <result column="product_status" property="productStatus" />
        <result column="task_number" property="taskNumber" />
        <result column="product_price" property="productPrice" />
        <result column="total_reward" property="totalReward" />
        <result column="task_price" property="taskPrice" />
        <result column="price_unit" property="priceUnit" />
        <result column="success_reward" property="successReward" />
        <result column="every_reward" property="everyReward" />
        <result column="product_type" property="productType" />
        <result column="s_order" property="sOrder" />
        <result column="total_number" property="totalNumber" />
        <result column="valid_days" property="validDays" />
        <result column="product_tag" property="productTag" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, type_id, product_name, product_img, product_des, product_detail, create_time, create_user, update_time, update_user,
        product_status, task_number, product_price, total_reward, task_price, price_unit, success_reward, every_reward,
        product_type, s_order, total_number, valid_days
    </sql>

    <select id="findProductDetail" resultType="sProduct" parameterType="sProduct">

        SELECT
            p.id,
            p.product_name productName,
            p.product_img productImg,
            p.product_des productDes,
            p.product_detail productDetail,
            p.create_time createTime,
            p.create_user createUser,
            p.update_time updateTime,
            p.update_user updateUser,
            p.product_status productStatus,
            p.task_number taskNumber,
            p.total_number totalNumber,
            p.valid_days validDays,
            p.product_tag productTag,
            p.s_order sOrder,
            p.product_price productPrice,
            p.total_reward totalReward,
            p.task_price taskPrice,
            p.price_unit priceUnit,
            p.success_reward successReward,
            p.every_reward everyReward,
            p.product_type productType,
            task.taskNumber taskPayCount,
            ifnull(follow.followCnt, 0) followCount,
            ifnull(f.status, 0) followStatus,
            level.buy_number buyNumber
        FROM s_product p
        LEFT JOIN (select product_id, sum(task_number) taskNumber from s_user_task where pay_status = 1 and status != 2 group by product_id) task
        ON task.product_id = p.id
        LEFT JOIN (select product_id, count(*) followCnt from s_user_follow where follow_type = 0 and status = 1 group by product_id) follow
        ON follow.product_id = p.id
        LEFT JOIN s_user_follow f ON f.user_id = #{sProduct.userId} AND f.product_id = p.id AND f.follow_type = 0
        LEFT JOIN s_user u ON u.id = #{sProduct.userId}
        LEFT JOIN s_user_level level ON level.id = u.user_level_id
        WHERE p.product_status = 1

        <if test="sProduct.id != null and sProduct.id != ''">
            AND p.id = #{sProduct.id}
        </if>

        <if test="sProduct.typeId != null and sProduct.typeId != ''">
            AND p.type_id = #{sProduct.typeId}
        </if>

        <if test="sProduct.productType != null and sProduct.productType != ''">
            AND p.product_type = #{sProduct.productType}
        </if>

    </select>


    
</mapper>
