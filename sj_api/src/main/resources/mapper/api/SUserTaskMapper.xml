<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cc.mrbird.febs.api.mapper.SUserTaskMapper">

        <!-- 通用查询映射结果 -->
        <resultMap id="BaseResultMap" type="cc.mrbird.febs.api.entity.SUserTask">
            <result column="id" property="id" />
            <result column="user_id" property="userId" />
            <result column="product_id" property="productId" />
            <result column="parent_id" property="parentId" />
            <result column="pay_status" property="payStatus" />
            <result column="pay_amount" property="payAmount" />
            <result column="pay_time" property="payTime" />
            <result column="task_number" property="taskNumber" />
            <result column="status" property="status" />
            <result column="share_flag" property="shareFlag" />
            <result column="create_time" property="createTime" />
            <result column="update_time" property="updateTime" />
        </resultMap>

        <!-- 通用查询结果列 -->
        <sql id="Base_Column_List">
                id,
            user_id, product_id, parent_id, pay_status, pay_amount, pay_time, task_number, status, share_flag, create_time, updateTime
        </sql>


        <select id="findUserTaskDetail" resultType="java.util.Map" parameterType="sUserTask">

            SELECT
                t.id taskId,
                t.user_id userId,
                t.product_id productId,
                t.task_number taskNumber,
                t.status status,
                t.create_time createTime,
                t.pay_time payTime,
                datediff(now(), t.pay_time) taskDays,
                p.product_name productName,
                p.product_img productImg,
                p.product_des productDes,
                p.product_detail productDetail,
                p.task_number totalTaskNumber,
                t2.taskNumberOK taskNumberOK,
                p.product_price productPrice,
                p.total_reward totalReward,
                p.task_price taskPrice,
                p.price_unit priceUnit,
                p.success_reward successReward,
                p.every_reward everyReward,

                o.price_type priceType,
                o.order_price orderPrice,
                o.end_time endTime

                oc.offerCount offerCount,

                op.amount amount,
                opu.user_name userName,
                opu.user_phone userPhone

              FROM s_user_task t
            LEFT JOIN s_product p ON p.id = t.product_id
            LEFT JOIN (SELECT product_id, SUM(task_number) taskNumberOK FROM s_user_task WHERE pay_status = 1 GROUP BY product_id) t2
              ON t2.product_id = p.id
            LEFT JOIN s_task_order o ON o.task_id = t.id AND o.user_id = t.user_id
            LEFT JOIN (SELECT task_order_id, count(*) offerCount FROM s_offer_price WHERE pay_status = 1 GROUP BY task_order_id) oc
              ON oc.task_order_id = o.id
            LEFT JOIN s_offer_price op ON op.task_order_id = o.id AND op.status IN (1, 3)
            LEFT JOIN s_user opu ON opu.id = op.user_id
            WHERE t.pay_status = 1

            <if test="sUserTask.userId != null and sUserTask.userId != ''">
                AND t.user_id = #{sUserTask.userId}
            </if>

            <if test="sUserTask.status != null and sUserTask.status != ''">
                AND t.status = #{sUserTask.status}
            </if>

        </select>

</mapper>
